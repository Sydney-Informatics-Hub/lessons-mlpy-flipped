<!DOCTYPE html>

<html>

<head>

<meta charset="utf-8" />
<meta name="generator" content="pandoc" />
<meta http-equiv="X-UA-Compatible" content="IE=EDGE" />




<title>10-LinReg.utf8</title>

<script src="site_libs/header-attrs-2.5.3/header-attrs.js"></script>
<script src="site_libs/jquery-1.11.3/jquery.min.js"></script>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<link href="site_libs/bootstrap-3.3.5/css/journal.min.css" rel="stylesheet" />
<script src="site_libs/bootstrap-3.3.5/js/bootstrap.min.js"></script>
<script src="site_libs/bootstrap-3.3.5/shim/html5shiv.min.js"></script>
<script src="site_libs/bootstrap-3.3.5/shim/respond.min.js"></script>
<script src="site_libs/jqueryui-1.11.4/jquery-ui.min.js"></script>
<link href="site_libs/tocify-1.9.1/jquery.tocify.css" rel="stylesheet" />
<script src="site_libs/tocify-1.9.1/jquery.tocify.js"></script>
<script src="site_libs/navigation-1.1/tabsets.js"></script>
<link href="site_libs/highlightjs-9.12.0/default.css" rel="stylesheet" />
<script src="site_libs/highlightjs-9.12.0/highlight.js"></script>

<style type="text/css">
  code{white-space: pre-wrap;}
  span.smallcaps{font-variant: small-caps;}
  span.underline{text-decoration: underline;}
  div.column{display: inline-block; vertical-align: top; width: 50%;}
  div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
  ul.task-list{list-style: none;}
    </style>

<style type="text/css">code{white-space: pre;}</style>
<style type="text/css">
  pre:not([class]) {
    background-color: white;
  }
</style>
<script type="text/javascript">
if (window.hljs) {
  hljs.configure({languages: []});
  hljs.initHighlightingOnLoad();
  if (document.readyState && document.readyState === "complete") {
    window.setTimeout(function() { hljs.initHighlighting(); }, 0);
  }
}
</script>



<style type="text/css">
h1 {
  font-size: 34px;
}
h1.title {
  font-size: 38px;
}
h2 {
  font-size: 30px;
}
h3 {
  font-size: 24px;
}
h4 {
  font-size: 18px;
}
h5 {
  font-size: 16px;
}
h6 {
  font-size: 12px;
}
.table th:not([align]) {
  text-align: left;
}
</style>

<link rel="stylesheet" href="lesson.css" type="text/css" />



<style type = "text/css">
.main-container {
  max-width: 940px;
  margin-left: auto;
  margin-right: auto;
}
code {
  color: inherit;
  background-color: rgba(0, 0, 0, 0.04);
}
img {
  max-width:100%;
}
.tabbed-pane {
  padding-top: 12px;
}
.html-widget {
  margin-bottom: 20px;
}
button.code-folding-btn:focus {
  outline: none;
}
summary {
  display: list-item;
}
</style>


<style type="text/css">
/* padding for bootstrap navbar */
body {
  padding-top: 61px;
  padding-bottom: 40px;
}
/* offset scroll position for anchor links (for fixed navbar)  */
.section h1 {
  padding-top: 66px;
  margin-top: -66px;
}
.section h2 {
  padding-top: 66px;
  margin-top: -66px;
}
.section h3 {
  padding-top: 66px;
  margin-top: -66px;
}
.section h4 {
  padding-top: 66px;
  margin-top: -66px;
}
.section h5 {
  padding-top: 66px;
  margin-top: -66px;
}
.section h6 {
  padding-top: 66px;
  margin-top: -66px;
}
.dropdown-submenu {
  position: relative;
}
.dropdown-submenu>.dropdown-menu {
  top: 0;
  left: 100%;
  margin-top: -6px;
  margin-left: -1px;
  border-radius: 0 6px 6px 6px;
}
.dropdown-submenu:hover>.dropdown-menu {
  display: block;
}
.dropdown-submenu>a:after {
  display: block;
  content: " ";
  float: right;
  width: 0;
  height: 0;
  border-color: transparent;
  border-style: solid;
  border-width: 5px 0 5px 5px;
  border-left-color: #cccccc;
  margin-top: 5px;
  margin-right: -10px;
}
.dropdown-submenu:hover>a:after {
  border-left-color: #ffffff;
}
.dropdown-submenu.pull-left {
  float: none;
}
.dropdown-submenu.pull-left>.dropdown-menu {
  left: -100%;
  margin-left: 10px;
  border-radius: 6px 0 6px 6px;
}
</style>

<script>
// manage active state of menu based on current page
$(document).ready(function () {
  // active menu anchor
  href = window.location.pathname
  href = href.substr(href.lastIndexOf('/') + 1)
  if (href === "")
    href = "index.html";
  var menuAnchor = $('a[href="' + href + '"]');

  // mark it active
  menuAnchor.parent().addClass('active');

  // if it's got a parent navbar menu mark it active as well
  menuAnchor.closest('li.dropdown').addClass('active');
});
</script>

<!-- tabsets -->

<style type="text/css">
.tabset-dropdown > .nav-tabs {
  display: inline-table;
  max-height: 500px;
  min-height: 44px;
  overflow-y: auto;
  background: white;
  border: 1px solid #ddd;
  border-radius: 4px;
}

.tabset-dropdown > .nav-tabs > li.active:before {
  content: "";
  font-family: 'Glyphicons Halflings';
  display: inline-block;
  padding: 10px;
  border-right: 1px solid #ddd;
}

.tabset-dropdown > .nav-tabs.nav-tabs-open > li.active:before {
  content: "&#xe258;";
  border: none;
}

.tabset-dropdown > .nav-tabs.nav-tabs-open:before {
  content: "";
  font-family: 'Glyphicons Halflings';
  display: inline-block;
  padding: 10px;
  border-right: 1px solid #ddd;
}

.tabset-dropdown > .nav-tabs > li.active {
  display: block;
}

.tabset-dropdown > .nav-tabs > li > a,
.tabset-dropdown > .nav-tabs > li > a:focus,
.tabset-dropdown > .nav-tabs > li > a:hover {
  border: none;
  display: inline-block;
  border-radius: 4px;
  background-color: transparent;
}

.tabset-dropdown > .nav-tabs.nav-tabs-open > li {
  display: block;
  float: none;
}

.tabset-dropdown > .nav-tabs > li {
  display: none;
}
</style>

<!-- code folding -->



<style type="text/css">

#TOC {
  margin: 25px 0px 20px 0px;
}
@media (max-width: 768px) {
#TOC {
  position: relative;
  width: 100%;
}
}

@media print {
.toc-content {
  /* see https://github.com/w3c/csswg-drafts/issues/4434 */
  float: right;
}
}

.toc-content {
  padding-left: 30px;
  padding-right: 40px;
}

div.main-container {
  max-width: 1200px;
}

div.tocify {
  width: 20%;
  max-width: 260px;
  max-height: 85%;
}

@media (min-width: 768px) and (max-width: 991px) {
  div.tocify {
    width: 25%;
  }
}

@media (max-width: 767px) {
  div.tocify {
    width: 100%;
    max-width: none;
  }
}

.tocify ul, .tocify li {
  line-height: 20px;
}

.tocify-subheader .tocify-item {
  font-size: 0.90em;
}

.tocify .list-group-item {
  border-radius: 0px;
}


</style>



</head>

<body>


<div class="container-fluid main-container">


<!-- setup 3col/9col grid for toc_float and main content  -->
<div class="row-fluid">
<div class="col-xs-12 col-sm-4 col-md-3">
<div id="TOC" class="tocify">
</div>
</div>

<div class="toc-content col-xs-12 col-sm-8 col-md-9">




<div class="navbar navbar-default  navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar">
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="index.html">Home</a>
    </div>
    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
        <li>
  <a href="setup.html">Setup</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Session 1
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
    <li>
      <a href="03-EDA.html">Exploratory Data Analysis</a>
    </li>
    <li>
      <a href="10-LinReg.html">Linear Regression</a>
    </li>
  </ul>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Session 2
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
    <li>
      <a href="11-RidgeLassoElasticNet.html">Regularised regression. PCR and PLSR.</a>
    </li>
    <li>
      <a href="30-RF_knn.html">Random Forests and k-NN regression</a>
    </li>
    <li>
      <a href="45-Xgboost.html">Gradient boosting. Extreme Gradient Boosting (XGBoost)</a>
    </li>
  </ul>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Session 3
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
    <li>
      <a href="50-Classification.html">Classification</a>
    </li>
  </ul>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Session 4
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
    <li>
      <a href="50-Classification.html">Classification (finish)</a>
    </li>
    <li>
      <a href="90-Unsupervised.html">Unsupervised learning</a>
    </li>
  </ul>
</li>
      </ul>
      <ul class="nav navbar-nav navbar-right">
        
      </ul>
    </div><!--/.nav-collapse -->
  </div><!--/.container -->
</div><!--/.navbar -->

<div class="fluid-row" id="header">




</div>


<!--
---
title: "Linear Regression."
author: "Darya Vanichkina"
keypoints: 
- Regression is the prediction of the value of a continuous variable based on one or more other continuous or categorical variables.
- Multiple types of regression can be implemented to fit the data

questions:
- How do we preprocess our data for modelling?
- How do we fit a basic linear model using scikit-learn?

objectives:
- To use sklearn.preprocessing to preprocess our data
- To fit and compare some basic linear models using one, two, or all of the variables in the dataset

source: Rmd
teaching: 30
exercises: 15
bibliography: references.bib
---
-->
<div id="linear-regression" class="section level2">
<h2>Linear regression</h2>
<pre class="python"><code># when delivering live coding, these libraries have already been loaded
import numpy as np
import pandas as pd
import statsmodels.api as sm
import matplotlib.pyplot as plt
import seaborn as sns
from scipy.special import exp10
%matplotlib inline
sns.set(font_scale = 1.5)
#
#
#
# do import these for the next sections to work:
from sklearn.pipeline import Pipeline
from pandas.api.types import CategoricalDtype
import pickle 

from sklearn.preprocessing import (
    StandardScaler, PolynomialFeatures, FunctionTransformer
)

from sklearn.model_selection import train_test_split
from sklearn.model_selection import GridSearchCV, RandomizedSearchCV

from sklearn.metrics import mean_squared_error, r2_score,  mean_absolute_error
from sklearn.linear_model import LinearRegression, LassoCV, RidgeCV, ElasticNetCV</code></pre>
<p>Define some functions to help us one hot encode variables, group together infrequently occuring cases, and create a “none of this feature” column.</p>
<pre class="python"><code># do live code the next code chunk
def onehot_row_drop(df, column = &#39;column&#39;):
    dummies = pd.get_dummies(df[column], drop_first=True, prefix=column)
    df = pd.concat([df.drop(column, axis=1), dummies],axis=1)
    return(df)

def group_infrequent(df, column_name, counts = 10):
    frequencies = df[column_name].value_counts()
    infrequent = frequencies[frequencies &lt;= counts].index
    df.loc[df[column_name].isin(infrequent), column_name] = &quot;Other&quot;

def none_of_this_feature(df, column = &#39;column&#39;):
    # adds a column to the dataframe with a value of 0 where there is none of this feature,
    # and a 1 where it&#39;s actually there
    df[&#39;No_&#39; + column] = np.where(df[column]==0, 0, 1)
    return(df)</code></pre>
<pre class="python"><code># you don&#39;t need to reload the data
# this is just here to make the note generation work
ameshousingClean = pd.read_csv(&#39;data/AmesHousingClean.csv&#39;)
ameshousingClean = ameshousingClean.loc[ameshousingClean[&#39;Gr_Liv_Area&#39;] &lt;= 4000, :]
#
#
#
#</code></pre>
<pre class="python"><code># But DO copy-paste the below code to proceed to the challenge
# step 1
ameshousingClean[&#39;Age&#39;] = ameshousingClean[&#39;Year_Sold&#39;].max() - ameshousingClean[&#39;Year_Built&#39;]
ameshousingClean[&#39;Remodel_Age&#39;] = ameshousingClean[&#39;Year_Sold&#39;].max() - ameshousingClean[&#39;Year_Remod_Add&#39;]
ameshousingClean[&#39;Misc_Feature_Present&#39;] =  np.where(ameshousingClean[&#39;Misc_Feature&#39;]==&quot;None&quot;, 0, 1)


# step 2
# group situations where there are less than 20 cases of something
infrequent_cols = [&#39;Neighborhood&#39;, &#39;Roof_Matl&#39;, &#39;Exterior_1st&#39;, &#39;Exterior_2nd&#39;, 
                   &#39;Heating&#39;, &#39;MS_Zoning&#39;, &#39;Misc_Feature&#39;, &#39;Sale_Type&#39;]
for col in infrequent_cols:
    group_infrequent(df=ameshousingClean, column_name=col, counts=20)


# Capture variables where some houses have &quot;none of this feature&quot; (i.e value of parameter = 0 aka zero-inflation)
none_of_feature = [&#39;Second_Flr_SF&#39;,&#39;Three_season_porch&#39;,&#39;BsmtFin_SF_2&#39;,&#39;Bsmt_Unf_SF&#39;,
                   &#39;Enclosed_Porch&#39;,&#39;Low_Qual_Fin_SF&#39;, &#39;Mas_Vnr_Area&#39;,&#39;Lot_Frontage&#39;,
                   &#39;Open_Porch_SF&#39;,&#39;Screen_Porch&#39;,&#39;Pool_Area&#39;,&#39;Wood_Deck_SF&#39;, 
                   &#39;BsmtFin_SF_2&#39;, &#39;Second_Flr_SF&#39;]
for col in none_of_feature:
    ameshousingClean = none_of_this_feature(df = ameshousingClean, column=col)
    
# step 3
categorical_variable_list = [&#39;Alley&#39;, &#39;Bldg_Type&#39;, &#39;Condition_1&#39;, &#39;Electrical&#39;, &#39;Exter_Cond&#39;, &#39;Exter_Qual&#39;, 
                             &#39;Foundation&#39;, &#39;Functional&#39;, &#39;House_Style&#39;, &#39;Kitchen_Qual&#39;, &#39;Land_Contour&#39;, 
                             &#39;Land_Slope&#39;, &#39;Lot_Config&#39;, &#39;Lot_Shape&#39;, &#39;Central_Air&#39;, &#39;Bsmt_Cond&#39;, 
                             &#39;Bsmt_Exposure&#39;, &#39;BsmtFin_Type_1&#39;, &#39;BsmtFin_Type_2&#39;, &#39;Bsmt_Qual&#39;, &#39;Fence&#39;, 
                             &#39;Fireplace_Qu&#39;, &#39;Garage_Cond&#39;, &#39;Garage_Finish&#39;, &#39;Garage_Type&#39;, &#39;Heating_QC&#39;,  
                              &#39;MS_SubClass&#39;,  &#39;Overall_Cond&#39;, &#39;Overall_Qual&#39;, 
                             &#39;Paved_Drive&#39;, &#39;Roof_Style&#39;, &#39;Year_Sold&#39;, &#39;Neighborhood&#39;, &#39;Roof_Matl&#39;, &#39;Exterior_2nd&#39;,
                            &#39;Exterior_1st&#39;, &#39;Heating&#39;, &#39;MS_Zoning&#39;, &#39;Misc_Feature&#39;, &#39;Street&#39;, 
                             &#39;Mas_Vnr_Type&#39;, &#39;Utilities&#39;,&quot;Condition_2&quot;, &quot;Pool_QC&quot;, &quot;Garage_Qual&quot;, &#39;Sale_Type&#39;, 
                             &#39;Sale_Condition&#39;]

# step 4
# one hot encode the other categoricals
for col in categorical_variable_list:
    ameshousingClean = onehot_row_drop(df = ameshousingClean, column=col)

# step 5
# drop double no basement: (ranges from 80 to 83 in dataset, going with 80)
columns_to_drop = [
    &#39;Bsmt_Exposure_No_Basement&#39;,&#39;BsmtFin_Type_2_No_Basement&#39;,&#39;Bsmt_Qual_No_Basement&#39;,
    &#39;Garage_Finish_No_Garage&#39;,&#39;Garage_Type_No_Garage&#39;,&#39;Garage_Qual_No_Garage&#39;,
    &#39;Year_Built&#39;,&#39;Year_Remod_Add&#39;,
]
ameshousingClean = ameshousingClean.drop(columns_to_drop, axis=1)</code></pre>
<blockquote>
<h2 id="challenge-1">Challenge 1</h2>
<p>Look at the code above. Can you explain why each of these transformations is being carried out? See if you can figure out, in your groups, what each of the steps is doing.</p>
<p>{: .source}</p>
<blockquote>
<h2 id="solution">Solution</h2>
<p>{: .output} {: .solution} {: .challenge}</p>
</blockquote>
</blockquote>
<p>Add a column to the dataset to split the Sale Price by percentile into 10 bins:</p>
<pre class="python"><code>ameshousingClean[&#39;Sale_Price_quartile&#39;] =  pd.qcut(ameshousingClean[&#39;Sale_Price&#39;], 10, 
                                                   labels=range(10))</code></pre>
<p>Now we can use scikit-learn’s train-test split to split the data into a training and testing subset, stratifying it by the percentile bin of the Sale_Price:</p>
<pre class="python"><code>index_train, index_test  = train_test_split(
    ameshousingClean.index.values, train_size=0.7, test_size = 0.3, 
    stratify = ameshousingClean[&#39;Sale_Price_quartile&#39;].values, random_state=42
)
#
#
## get rid of the quartile column so we&#39;re not using it to predict sale price
ameshousingClean = ameshousingClean.drop(&#39;Sale_Price_quartile&#39;, axis = 1)

# Create variables for the training and test sets 
ames_train = ameshousingClean.loc[index_train,:].copy()
ames_test = ameshousingClean.loc[index_test,:].copy()</code></pre>
<pre class="python"><code># What are their dimensions?
print(ames_train.shape)
print(ames_test.shape)</code></pre>
<pre><code>(2047, 287)
(878, 287)</code></pre>
<p>Get a list of predictor names and make numpy matrices of the data:</p>
<pre class="python"><code>predictors = ameshousingClean.columns.values.tolist()
predictors.remove(&#39;Sale_Price&#39;)

# this is extra, to help keep  the train/test consistent between different page renders
# in jekyll. Not necessary for teaching
pickle.dump(predictors, open(&#39;models/predictors.pickle&#39;, &#39;wb&#39;))</code></pre>
<pre class="python"><code># define a transformation function for the Y
log_transf_f = FunctionTransformer(
    func=np.log10,
    inverse_func=exp10,
    validate=True
)</code></pre>
<pre class="python"><code># Create training and test response vectors
ames_train_y = log_transf_f.fit_transform(ames_train[&#39;Sale_Price&#39;].values.reshape(-1, 1))
ames_test_y = log_transf_f.transform(ames_test[&#39;Sale_Price&#39;].values.reshape(-1, 1))

# Write training and test design matrices
ames_train_X = ames_train[predictors].copy()
ames_test_X = ames_test[predictors].copy()


# save them to files as well (this is an extra step that&#39;s not necessary in class, but useful for our jupyter notebook class notes)
pickle.dump(ames_train_y, open(&#39;models/ames_train_y.pickle&#39;, &#39;wb&#39;))
pickle.dump(ames_test_y, open(&#39;models/ames_test_y.pickle&#39;, &#39;wb&#39;))
pickle.dump(ames_train_X, open(&#39;models/ames_train_X.pickle&#39;, &#39;wb&#39;))
pickle.dump(ames_test_X, open(&#39;models/ames_test_X.pickle&#39;, &#39;wb&#39;))</code></pre>
<pre class="python"><code>type(ames_train_X)</code></pre>
<pre><code>pandas.core.frame.DataFrame</code></pre>
<pre class="python"><code>type(ames_train_y)</code></pre>
<pre><code>numpy.ndarray</code></pre>
</div>
<div id="fit-ols-models-with-different-features" class="section level2">
<h2>Fit OLS models with different features</h2>
<pre class="python"><code>## Fit an Ordinary Least Squares Regression using all variables
ames_ols_all = LinearRegression()
ames_ols_all.fit(ames_train_X, ames_train_y)


## Fit an Ordinary Least Squares Regression using Gr_Liv_Area
ames_ols_GrLivArea = LinearRegression()
# Note: need [] around the column name so it is kept as a dataframe
ames_ols_GrLivArea.fit(ames_train_X.loc[:, [&#39;Gr_Liv_Area&#39;]], ames_train_y)

## 
ames_ols_Second_Flr_SF = LinearRegression()
ames_ols_Second_Flr_SF.fit(ames_train_X.loc[:, [&#39;Second_Flr_SF&#39;]], ames_train_y)

## Fit an Ordinary Least Squares Regression using Gr_Liv_Area and Second_Flr_SF
ames_ols_GrLivArea_Second_Flr_SF = LinearRegression()
ames_ols_GrLivArea_Second_Flr_SF.fit(ames_train_X[[&#39;Gr_Liv_Area&#39;,&#39;Second_Flr_SF&#39;]], ames_train_y)

## Fit an Ordinary Least Squares Regression using Gr_Liv_Area and Age
ames_ols_GrLivArea_Age = LinearRegression()
ames_ols_GrLivArea_Age.fit(ames_train_X[[&#39;Gr_Liv_Area&#39;,&#39;Age&#39;]], ames_train_y)</code></pre>
<pre><code>LinearRegression(copy_X=True, fit_intercept=True, n_jobs=None, normalize=False)</code></pre>
</div>
<div id="assess-model-fit" class="section level2">
<h2>Assess model fit</h2>
<p>Assess model fit on the training data:</p>
<pre class="python"><code>## Paste the function below, then go slowly through how it is built up
def assess_fit_vars(models, variables, datasetX, datasetY):
    columns = [&#39;RMSE&#39;, &#39;R2&#39;, &#39;MAE&#39;]
    results = pd.DataFrame(0.0, columns=columns, index=variables)
    # compute the actual Y
    y_actual = log_transf_f.inverse_transform(datasetY)
    for i, method in enumerate(models):
        if variables[i] != &quot;All&quot;:
            tmp_dataset_X = datasetX[variables[i]]
            if type(variables[i]) == str: #only one column - so need to reshape
                tmp_dataset_X = datasetX[variables[i]].values.reshape(-1, 1)
        else:
            tmp_dataset_X = datasetX
        # while we build the model and predict on the log10Transformed sale price, we display the error in dollars
        # as that makes more sense
        y_pred = log_transf_f.inverse_transform(method.predict(tmp_dataset_X))
        results.iloc[i,0] = np.sqrt(
            mean_squared_error(y_actual, y_pred))
        results.iloc[i,1] = r2_score(y_actual, y_pred)
        results.iloc[i,2] = mean_absolute_error(y_actual, y_pred)
    return results.round(3)

models = [ames_ols_all, ames_ols_GrLivArea, ames_ols_Second_Flr_SF, 
          ames_ols_GrLivArea_Age, ames_ols_GrLivArea_Second_Flr_SF]

variables = [&quot;All&quot;, &#39;Gr_Liv_Area&#39;,&#39;Second_Flr_SF&#39;,
            [&#39;Gr_Liv_Area&#39;, &#39;Age&#39;], [&#39;Gr_Liv_Area&#39;, &#39;Second_Flr_SF&#39;]]

compare_train = assess_fit_vars(
    models=models,
    variables=variables, 
    datasetX=ames_train_X, 
    datasetY=ames_train_y
)
compare_train.sort_values(&#39;RMSE&#39;)</code></pre>
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
<thead>
<tr style="text-align: right;">
<th>
</th>
<th>
RMSE
</th>
<th>
R2
</th>
<th>
MAE
</th>
</tr>
</thead>
<tbody>
<tr>
<th>
All
</th>
<td>
15757.714
</td>
<td>
0.961
</td>
<td>
10931.668
</td>
</tr>
<tr>
<th>
[Gr_Liv_Area, Age]
</th>
<td>
42838.016
</td>
<td>
0.709
</td>
<td>
29175.241
</td>
</tr>
<tr>
<th>
[Gr_Liv_Area, Second_Flr_SF]
</th>
<td>
54774.347
</td>
<td>
0.524
</td>
<td>
36413.963
</td>
</tr>
<tr>
<th>
Gr_Liv_Area
</th>
<td>
57157.444
</td>
<td>
0.481
</td>
<td>
39045.817
</td>
</tr>
<tr>
<th>
Second_Flr_SF
</th>
<td>
78064.434
</td>
<td>
0.033
</td>
<td>
53060.044
</td>
</tr>
</tbody>
</table>
</div>
<p>Let’s built a comparison plot</p>
<pre class="python"><code># rearrange the scores df to for the plot
def rearrange_df(df):
    out_df = (
        df.copy()
        .reset_index()
        .melt(
            id_vars=&#39;index&#39;,
            value_vars=df.columns.values.tolist(),
            var_name=&#39;metric&#39;,
            value_name=&#39;number&#39;
        )
        .sort_values(&#39;number&#39;)
    )
    out_df[&#39;index&#39;] = out_df[&#39;index&#39;].astype(str)
    out_df= out_df.rename(columns={&#39;index&#39;:&#39;model_features&#39;})
    return out_df</code></pre>
<pre class="python"><code>chart = sns.catplot(
    x=&#39;model_features&#39;,
    y=&#39;number&#39;,
    col=&#39;metric&#39;,
    data=rearrange_df(compare_train),
    kind=&#39;bar&#39;,
    sharey=False,
)
chart.set_xticklabels(rotation=90);</code></pre>
<div class="figure">
<img src="10-LinReg_files/10-LinReg_25_0.png" alt="" />
<p class="caption">png</p>
</div>
<p>Compare with peformance on the test set</p>
<pre class="python"><code># on the test! set
compare = assess_fit_vars(
    models=models, variables=variables, 
    datasetX=ames_test_X, datasetY=ames_test_y
)
compare.sort_values(&#39;RMSE&#39;)</code></pre>
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
<thead>
<tr style="text-align: right;">
<th>
</th>
<th>
RMSE
</th>
<th>
R2
</th>
<th>
MAE
</th>
</tr>
</thead>
<tbody>
<tr>
<th>
All
</th>
<td>
20541.485
</td>
<td>
0.928
</td>
<td>
13346.733
</td>
</tr>
<tr>
<th>
[Gr_Liv_Area, Age]
</th>
<td>
39888.647
</td>
<td>
0.729
</td>
<td>
27876.134
</td>
</tr>
<tr>
<th>
[Gr_Liv_Area, Second_Flr_SF]
</th>
<td>
49934.445
</td>
<td>
0.575
</td>
<td>
35199.582
</td>
</tr>
<tr>
<th>
Gr_Liv_Area
</th>
<td>
55373.269
</td>
<td>
0.477
</td>
<td>
37740.468
</td>
</tr>
<tr>
<th>
Second_Flr_SF
</th>
<td>
73795.736
</td>
<td>
0.071
</td>
<td>
51293.938
</td>
</tr>
</tbody>
</table>
</div>
<p>Let’s compare the scores across train and test sets</p>
<pre class="python"><code># combine test and train dfs
def combine_train_test_res_df(df_train_scores, df_test_scores):
    df = rearrange_df(df_train_scores)
    df[&#39;dataset&#39;] = &#39;train&#39;
    df1 = rearrange_df(df_train_scores)
    df1[&#39;dataset&#39;] = &#39;test&#39;
    return df.append(df1)</code></pre>
<pre class="python"><code>chart = sns.catplot(
    x=&#39;model_features&#39;,
    y=&#39;number&#39;,
    col=&#39;metric&#39;,
    data=combine_train_test_res_df(compare_train, compare),
    kind=&#39;bar&#39;,
    sharey=False,
    hue=&#39;dataset&#39;
)
chart.set_xticklabels(rotation=90);</code></pre>
<div class="figure">
<img src="10-LinReg_files/10-LinReg_30_0.png" alt="" />
<p class="caption">png</p>
</div>
<pre class="python"><code># lets explore the coefficients
print(ameshousingClean.columns.get_loc(&#39;Gr_Liv_Area&#39;))
print(ameshousingClean.columns.get_loc(&#39;Age&#39;))
print(ameshousingClean.columns.get_loc(&#39;Second_Flr_SF&#39;))</code></pre>
<pre><code>10
32
8</code></pre>
<blockquote>
<h2 id="challenge-2">Challenge 2</h2>
<ol style="list-style-type: decimal">
<li><p>Explore the coefficients for Gr_Liv_Area, Second_Flr_SF, Gr_Liv_Area + Second_Flr_SF, Gr_Liv_Area + Age, and the coefficients for these parameters for a model that incorporates all of them. What do you observe? Are the coefficients for each parameter consistent among all the models?</p></li>
<li><p>Which model performs the best? Why?</p></li>
<li><p>Does the same model perform best for the training and test data? Why?</p></li>
</ol>
<p>{: .source}</p>
<blockquote>
<h2 id="solution-1">Solution</h2>
<p>This is a discussion challenge. Answers will be discussed as a group. To get the coefficients for each model, use the <code>ames_ols_GrLivArea.coef_</code> method. ~~~ ames_ols_GrLivArea.coef_ ames_ols_Second_Flr_SF.coef_ ames_ols_GrLivArea_Age.coef_ ames_ols_GrLivArea_Second_Flr_SF.coef_ ~~~</p>
<p>{: .output} {: .solution} {: .challenge}</p>
</blockquote>
</blockquote>
<pre class="python"><code># the below is only necessary to build the web pages; do not use for class
# save OLS model to pickle
pickle.dump(ames_ols_all, open(&#39;models/ames_ols_all.pickle&#39;, &#39;wb&#39;))</code></pre>
</div>
<div id="extra-interactions" class="section level2">
<h2>Extra: interactions</h2>
<p>We can also use some of the <code>scikit-learn</code> tools to create interaction terms, e.g. an interaction between the ground floor living area and second floor square footage. This is a little bit harder to integrate with our previous models (as we have to create a dataset with a new interaction term in it), so it has been kept separate:</p>
<pre class="python"><code># Create interaction term (not polynomial features) 
interaction = PolynomialFeatures(degree=2, include_bias=False, interaction_only=True) 
X_inter = interaction.fit_transform(ames_train_X[[&#39;Gr_Liv_Area&#39;,&#39;Second_Flr_SF&#39;]])
X_inter = pd.DataFrame(
    X_inter, 
    columns = interaction.get_feature_names([&#39;Gr_Liv_Area&#39;,&#39;Second_Flr_SF&#39;])
)
ames_ols_GrLivArea_Second_Flr_SF_interaction = LinearRegression() 
ames_ols_GrLivArea_Second_Flr_SF_interaction.fit(X_inter, ames_train_y)</code></pre>
<pre><code>LinearRegression(copy_X=True, fit_intercept=True, n_jobs=None, normalize=False)</code></pre>
<pre class="python"><code># Training performance
assess_fit_vars(
    models=[ames_ols_GrLivArea_Second_Flr_SF_interaction], 
    variables=[&quot;All&quot;], 
    datasetX=X_inter, datasetY=ames_train_y
)</code></pre>
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
<thead>
<tr style="text-align: right;">
<th>
</th>
<th>
RMSE
</th>
<th>
R2
</th>
<th>
MAE
</th>
</tr>
</thead>
<tbody>
<tr>
<th>
All
</th>
<td>
55222.314
</td>
<td>
0.516
</td>
<td>
36406.468
</td>
</tr>
</tbody>
</table>
</div>
<pre class="python"><code># Test performance
X_inter_test = interaction.fit_transform(ames_test_X[[&#39;Gr_Liv_Area&#39;,&#39;Second_Flr_SF&#39;]])
X_inter_test = pd.DataFrame(
    X_inter_test, 
    columns = interaction.get_feature_names([&#39;Gr_Liv_Area&#39;,&#39;Second_Flr_SF&#39;])
)

assess_fit_vars(
    models=[ames_ols_GrLivArea_Second_Flr_SF_interaction], 
    variables=[&quot;All&quot;], 
    datasetX=X_inter_test, datasetY=ames_test_y
)</code></pre>
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
<thead>
<tr style="text-align: right;">
<th>
</th>
<th>
RMSE
</th>
<th>
R2
</th>
<th>
MAE
</th>
</tr>
</thead>
<tbody>
<tr>
<th>
All
</th>
<td>
49301.482
</td>
<td>
0.585
</td>
<td>
35003.994
</td>
</tr>
</tbody>
</table>
</div>
</div>



</div>
</div>

</div>

<script>

// add bootstrap table styles to pandoc tables
function bootstrapStylePandocTables() {
  $('tr.odd').parent('tbody').parent('table').addClass('table table-condensed');
}
$(document).ready(function () {
  bootstrapStylePandocTables();
});


</script>

<!-- tabsets -->

<script>
$(document).ready(function () {
  window.buildTabsets("TOC");
});

$(document).ready(function () {
  $('.tabset-dropdown > .nav-tabs > li').click(function () {
    $(this).parent().toggleClass('nav-tabs-open')
  });
});
</script>

<!-- code folding -->

<script>
$(document).ready(function ()  {

    // move toc-ignore selectors from section div to header
    $('div.section.toc-ignore')
        .removeClass('toc-ignore')
        .children('h1,h2,h3,h4,h5').addClass('toc-ignore');

    // establish options
    var options = {
      selectors: "h1,h2,h3",
      theme: "bootstrap3",
      context: '.toc-content',
      hashGenerator: function (text) {
        return text.replace(/[.\\/?&!#<>]/g, '').replace(/\s/g, '_');
      },
      ignoreSelector: ".toc-ignore",
      scrollTo: 0
    };
    options.showAndHide = true;
    options.smoothScroll = true;

    // tocify
    var toc = $("#TOC").tocify(options).data("toc-tocify");
});
</script>

<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    script.src  = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML";
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>

</body>
</html>
